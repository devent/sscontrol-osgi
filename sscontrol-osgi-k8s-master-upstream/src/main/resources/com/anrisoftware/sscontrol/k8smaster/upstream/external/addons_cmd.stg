startAddon(parent, vars) ::= <<
curl --silent -H "Content-Type: application/yaml" -XPOST -d"$(cat <parent.srvManifestsDir>/<vars.manifestFile>)" "<first(parent.service.cluster.apiServers)>/apis/extensions/v1beta1/namespaces/kube-system/deployments" > /dev/null
>>

startCalico(parent, vars) ::= <<
echo "Deploying Calico"
# Deploy Calico
#TODO: change to rkt once this is resolved (https://github.com/coreos/rkt/issues/3181)
K8S_VER=<parent.kubernetesVersion>
HYPERKUBE_IMAGE_REPO=<parent.hypercubeImageRepo>
docker run --rm --net=host -v <parent.srvManifestsDir>:/host/manifests "\$HYPERKUBE_IMAGE_REPO:\$K8S_VER" /hyperkube kubectl apply -f /host/manifests/calico.yaml

>>

waitApi(parent, vars) ::= <<
echo "Waiting for Kubernetes API..."
<parent.service.cluster.apiServers:waitForServer();separator=",">
>>

waitForServer(server) ::= <<
until curl --silent "<server>/version/"
do
    sleep 5
done
>>
