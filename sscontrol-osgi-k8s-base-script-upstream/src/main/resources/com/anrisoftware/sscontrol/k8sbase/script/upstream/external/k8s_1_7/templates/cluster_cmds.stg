startAddon(parent, vars) ::= <<
kubectl apply -f "<parent.srvManifestsDir>/<vars.manifestFile>"
>>

applyTains(parent, vars) ::= <<
<waitNode(parent, vars)>
node=$(<getNode(parent, vars)>)
kubectl taint --overwrite nodes $node <vars.taint.key>=<vars.value>:<vars.taint.effect>
>>

waitNode(parent, vars) ::= <<
echo "Waiting for node..."
until <getNode(parent, vars)>
do
    sleep 5
done
>>

getNode(parent, vars) ::= <<
kubectl get nodes -o custom-columns="NAME:.metadata.name" --no-headers --selector="<parent.robobeeLabelNamespace>/node=<parent.service.cluster.name>"
>>

waitApi(parent, vars) ::= <<
echo "Waiting for Kubernetes API..."
<parent.service.cluster.apiServers:waitForServer();separator=",">
>>

waitForServer(server) ::= <<
until curl --silent "<server>/version/"
do
    sleep 5
done
>>
