startAddon(parent, vars) ::= <<
kubectl apply -f "<parent.srvManifestsDir>/<vars.manifestFile>"

>>

waitApi(parent, vars) ::= <<
<parent.service.cluster.apiServers:waitForServer();separator=",">
>>

waitForServer(server) ::= <<
tmp_out=`mktemp`
trap "rm -f $tmp_out" EXIT
until curl --silent "<server>/version/"
do
    echo "Waiting for Kubernetes API..."
    systemctl status kubelet > $tmp_out
    ret=$?
    if [[ ! $ret -eq 0 ]]; then
        echo "Error waiting for the Kubernetes API:"
        cat $tmp_out
        exit $ret
    fi
    sleep 5
done
>>
